{
  "_args": [
    [
      {
        "raw": "tilerator@git+https://github.com/kartotherian/tilerator.git#master",
        "scope": null,
        "escapedName": "tilerator",
        "name": "tilerator",
        "rawSpec": "git+https://github.com/kartotherian/tilerator.git#master",
        "spec": "git+https://github.com/kartotherian/tilerator.git#master",
        "type": "hosted",
        "hosted": {
          "type": "github",
          "ssh": "git@github.com:kartotherian/tilerator.git#master",
          "sshUrl": "git+ssh://git@github.com/kartotherian/tilerator.git#master",
          "httpsUrl": "git+https://github.com/kartotherian/tilerator.git#master",
          "gitUrl": "git://github.com/kartotherian/tilerator.git#master",
          "shortcut": "github:kartotherian/tilerator#master",
          "directUrl": "https://raw.githubusercontent.com/kartotherian/tilerator/master/package.json"
        }
      },
      "/opt/service"
    ]
  ],
  "_from": "git+https://github.com/kartotherian/tilerator.git#master",
  "_id": "tilerator@0.0.25",
  "_inCache": true,
  "_location": "/tilerator",
  "_phantomChildren": {
    "camelcase": "3.0.0",
    "cliui": "3.2.0",
    "decamelize": "1.2.0",
    "get-caller-file": "1.0.3",
    "lodash.assign": "4.2.0",
    "os-locale": "1.4.0",
    "read-pkg-up": "1.0.1",
    "require-directory": "2.1.1",
    "require-main-filename": "1.0.1",
    "set-blocking": "2.0.0",
    "string-width": "1.0.2",
    "which-module": "1.0.0",
    "y18n": "3.2.1"
  },
  "_requested": {
    "raw": "tilerator@git+https://github.com/kartotherian/tilerator.git#master",
    "scope": null,
    "escapedName": "tilerator",
    "name": "tilerator",
    "rawSpec": "git+https://github.com/kartotherian/tilerator.git#master",
    "spec": "git+https://github.com/kartotherian/tilerator.git#master",
    "type": "hosted",
    "hosted": {
      "type": "github",
      "ssh": "git@github.com:kartotherian/tilerator.git#master",
      "sshUrl": "git+ssh://git@github.com/kartotherian/tilerator.git#master",
      "httpsUrl": "git+https://github.com/kartotherian/tilerator.git#master",
      "gitUrl": "git://github.com/kartotherian/tilerator.git#master",
      "shortcut": "github:kartotherian/tilerator#master",
      "directUrl": "https://raw.githubusercontent.com/kartotherian/tilerator/master/package.json"
    }
  },
  "_requiredBy": [
    "/"
  ],
  "_resolved": "git+https://github.com/kartotherian/tilerator.git#c988d10c1e8b79604d6c33afcf262e1837a7052b",
  "_shasum": "59a6b413e631231066f02c7af7a7300198de333d",
  "_shrinkwrap": null,
  "_spec": "tilerator@git+https://github.com/kartotherian/tilerator.git#master",
  "_where": "/opt/service",
  "author": {
    "name": "Yuri Astrakhan",
    "email": "YuriAstrakhan@gmail.com"
  },
  "bugs": {
    "url": "https://github.com/kartotherian/tilerator/issues"
  },
  "contributors": [
    {
      "name": "Max Semenik",
      "email": "msemenik@wikimedia.org"
    }
  ],
  "dependencies": {
    "@kartotherian/autogen": "^0.0.10",
    "@kartotherian/babel": "^0.2.6",
    "@kartotherian/cassandra": "^0.2.1",
    "@kartotherian/core": "^0.3.0",
    "@kartotherian/err": "^0.0.4",
    "@kartotherian/input-validator": "^0.0.6",
    "@kartotherian/jobprocessor": "^0.0.18",
    "@kartotherian/layermixer": "^0.0.8",
    "@kartotherian/osm-bright-source": "^1.0.1",
    "@kartotherian/osm-bright-style": "^4.0.1",
    "@kartotherian/overzoom": "^0.0.16",
    "@kartotherian/postgres": "^0.0.11",
    "@kartotherian/server": "^0.0.26",
    "@kartotherian/substantial": "^0.0.10",
    "@kartotherian/tilelive-tmsource": "~0.7.0",
    "@kartotherian/tilelive-vector": "~3.9.6",
    "@mapbox/tilelive": "~5.12.2",
    "@mapbox/tilelive-bridge": "~2.3.1",
    "bluebird": "^3.5.0",
    "body-parser": "^1.15.0",
    "bunyan": "^1.8.1",
    "bunyan-prettystream": "*",
    "cassandra-uuid": "^0.0.2",
    "compression": "^1.6.1",
    "domino": "^1.0.24",
    "express": "^4.13.4",
    "heapdump": "*",
    "htcp-purge": "^0.1.2",
    "jade": "^1.11.0",
    "js-yaml": "^3.8.2",
    "kue": "^0.11.0",
    "kue-ui-express": "^1.0.2",
    "mapnik": "~3.5.0",
    "minimist": "0.2.*",
    "preq": "^0.5.2",
    "quadtile-index": "^0.0.6",
    "service-runner": "^2.2.5",
    "tilelive-tmstyle": "0.8.0",
    "underscore": "^1.8.3",
    "why-is-node-running": "^1.2.2",
    "yargs": "^5.0.0"
  },
  "deploy": {
    "node": "6.11",
    "target": "debian",
    "install_opts": [
      "--build-from-source=mapnik",
      "--fallback-to-build=false"
    ],
    "dependencies": {
      "_all": [
        "libcairo2-dev",
        "libgif-dev",
        "libpango1.0-dev"
      ],
      "ubuntu": [
        "libjpeg62-dev"
      ],
      "debian": [
        "libjpeg62-turbo-dev",
        "fonts-dejavu",
        "libboost-filesystem-dev",
        "libboost-program-options-dev",
        "libboost-regex-dev",
        "libboost-system-dev",
        "libboost-thread-dev",
        "libgdal-dev",
        "libicu-dev",
        "libpq-dev",
        "libcurl4-gnutls-dev",
        "libproj-dev",
        "libtiff-dev",
        "libwebp5",
        {
          "repo_url": "https://apt.wikimedia.org/wikimedia",
          "release": "jessie-wikimedia",
          "pool": "backports",
          "packages": [
            "libmapbox-variant-dev",
            "libmapnik-dev",
            "mapnik-utils"
          ]
        }
      ]
    }
  },
  "description": "Map tiles pre-generation service",
  "devDependencies": {
    "eslint-config-airbnb-base": "^12.1.0",
    "eslint-config-kartotherian": "^0.0.5",
    "extend": "^3.0.0",
    "grunt": "^1.0.2",
    "grunt-contrib-watch": "^1.0.0",
    "grunt-eslint": "^20.1.0",
    "grunt-mocha-test": "^0.13.3",
    "istanbul": "^0.4.3",
    "mocha": "^5.0.4",
    "mocha-lcov-reporter": "^1.2.0",
    "swagger-router": "^0.4.2",
    "tilelive-file": "~0.0.3",
    "tilelive-http": "~0.13.0",
    "wait-as-promised": "^1.0.2"
  },
  "gitHead": "c988d10c1e8b79604d6c33afcf262e1837a7052b",
  "homepage": "https://github.com/kartotherian/tilerator",
  "keywords": [
    "REST",
    "API",
    "service template",
    "MediaWiki"
  ],
  "license": "Apache-2.0",
  "main": "./app.js",
  "name": "tilerator",
  "optionalDependencies": {
    "bunyan-prettystream": "*"
  },
  "readme": "[![Build Status](https://travis-ci.org/kartotherian/tilerator.svg?branch=master)](https://travis-ci.org/kartotherian/tilerator)\n# Map Tile Pre-Generation Service for [Kartotherian](https://github.com/kartotherian/kartotherian)\n\n**Tilerator** (Russian: Тилератор, tee-LEH-ruh-tor)\n\nThis code is cross-hosted at [gerrit](https://git.wikimedia.org/summary/maps%2FTilerator)\n\nGenerating tiles from the SQL queries sometimes requires a considerable time, often too long for the web request. Tilerator is a multi-processor, cluster-enabled tile generator, that allows both pre-generation and dirty tile re-generation.\n\nScheduled generation job waits in the queue ([kue](https://github.com/Automattic/kue)) until it is picked up by one of the workers. The worker will update job progress, as well as store intermediate data to allow restarts/crash recovery.\n\nTilerator is an unprotected Admin tool, and should NOT be exposed to the web. By default, Tilerator only accepts connections from the localhost. It is recommended that it is left this way, and used via a port forwarding ssh tunnel with `ssh -L 6534:localhost:6534 my.maps.server`\n\nTilerator also has a `tileshell` script to perform some of the admin tasks without using the http protocol.\n\n## Configuration\nInside the `conf` key:\n* `sources` - (required) Either a set of subkeys, a filename, or a list of file names.  See [core](https://github.com/kartotherian/core) on how to configure the sources.\n* `variables` - (optional) specify a set of variables (string key-value pairs) to be used inside sources, or it could be a filename or a list of filenames/objects.\n* `uiOnly`- (optional, boolean) runs Tilerator in UI mode - does not generate tiles, but still allows access to the web-based queue management tools.\n* `daemonOnly`- (optional, boolean) runs Tilerator in daemon mode - generates tiles, but does not allows access to the web-based queue management tools.\nFor the rest of the configuration parameters, see [service runner](https://github.com/wikimedia/service-runner) config info.\n* redis - (optional) configures redis server connection, e.g. redis://example.com:1234?redis_option=value&redis_option=value\n\n## Single index concept\n* Internally, all [X,Y] coordinates are converted to a single integer, with values 0..(4^zoom-1). This index is constructed\nby taking bits of both X and Y coordinates one bit at a time, thus every odd bit of the index represents the X, and every even bit represents the Y coordinates.\n\nThis allows us to easily treat the whole tile space as one linear space, yet provides for a convenient way to calculate other zoom levels.\nFor example, by simply dividing the index by 4, we get the index of the tile that includes current tile with zoom-1.\n\n## Monitoring Jobs\nIt is highly recomended, although not mandatory, to have an extra instance of the Tilerator running with the uiOnly setting in the config.\nThis way if Tilerator can be stopped and the pending jobs rearranged. Without the uiOnly instance, you will always be changing the queue\nwhile jobs are running.  To configure the uiOnly instance, make a copy of the Tilerator config, set uiOnly to true and change the port number.\nTo see the currently running jobs, navigate to `http://localhost:6534/` (nicer interface) or `http://localhost:6534/raw` (internal data).\n\n## Job auto-balancing\nTilerator will auto-rebalance jobs if it detects\n\n## Adding jobs\nJobs can be scheduled via a POST request. The best way is to use /static/admin.html from the Kartotherian deployment,\nand point it to Tilerator instance. Or you can make direct calls with [Chrome Postman extension](https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop?hl=en) or similar.\n\nThe most basic call to generate all tiles of zoom level 3, using `gen` source to produce tiles, and store them in the `store` source.  This job will be executed by one worker, without any multitasking.\n```\nhttp://localhost:6534/add?generatorId=gen&storageId=store&zoom=3\n```\n\n### Job Parameters\n* `generatorId` - required source ID, as defined in the sources configuration. Tiles from this source will be read.\n* `storageId` - required source ID, as defined in the sources configuration. Tiles will be written to this source.\n* `zoom` - zoom level to process\n* `parts` - break the job into NNN independent jobs, allowing it to run in multiple workers and/or machines\n* `idxFrom` - the starting tile index (inclusive, 0 by default)\n* `idxBefore`- generate tiles until this index (non-inclusive, 4^zoom by default)\n* `x` and `y` - generate just one tile at these coordinates. Cannot be used with `idxFrom` or `idxBefore`. Coordinates are based on the [Slippy Map Tile Names](https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames) system. These can be generated easily with [Geofabrik's calculator](http://tools.geofabrik.de/calc/#type=geofabrik_standard&grid=1).\n* `deleteEmpty` - if true, any non-generated tile (e.g. empty or solid) will be explicitly deleted from the storage (optional, false by default)\n* `keepJob` - if true, the job will not be automatically removed from the que once it successfully completes\n\n### Pyramid mode\nSpecifying `fromZoom` and `beforeZoom` enables pyramid mode. This mode tells Tilerator to generate more than\none zoom level with one request. Given a tip of the pyramid - a tile at a given zoom level `zoom`,\nthe pyramid will contain all the tiles under the given tile (higher zooms), and all the tiles that contain the given tile (lower zooms).\nSo a `zoom+1` will be the 4 tiles corresponding to the tip tile, and `zoom+2` will have the 16 tiles, etc.\nFor all zoom levels lower than `zoom`, Tilerator will add just one tile per `zoom` that contains the tip tile.\nTilerator will only generate the range of zooms requested, which does not have to contain the `zoom` (a cross-section of the piramid)\nThe base zoom may contain more than just one tile or even a whole zoom level. Use idxFrom & idxBefore to specify the tile range, or (x,y) for just one tile.\n\nThis feature could be useful for the tile invalidation. For example, a user edited a tile at Z=16, and the system automatically scheduled tile refresh at Z=10..17)\n\n* `zoom` - the zoom level of the pyramid's tip\n* `fromZoom` - zoom level at which to start generation (inclusive)\n* `beforeZoom` - zoom level to end tile generation (exclusive)\n\n### Parsing updates file\nSpecifying `filepath` parameter will load that file from the localhost and append its content to the queue. The file\n must already exist on the server.  Alternatively, you can specify `expdirpath`, `statefile` and `expmask` parameters,\n which would parse all files stored at the `expdirpath` that match regular expression `expmask`, and whose string value\n is greater than value stored in the file `statefile` (filename only). Once parsing is complete, the last filename\n will be stored in the statefile, overriding previous content.\n\nEeach expiration file must be in the format created by osm2pgsql, and all lines must be of the same zoom level:\n\n```\nzoom/x_coordinate/y_coordinate\n```\n\nTilerator will convert this file into a list of indexes, sort/deduplicate them, and schedule all the needed jobs.\nUse `fromZoom` and `beforeZoom` to invalidate more than just the zoom level given in the file. Note that if the zoom range is\ngiven, only those zooms will be regenerated. So if the zoom level in the file is not in `fromZoom <= zoom < beforeZoom`,\nthat zoom level will not be regenerated.  If you have a file has already been converted to the internal format of one index per line,\nand has no zoom, the zoom can be supplied via the `fileZoomOverride` (only works with `filepath` param).\n\n NOTE: Please remember that Tilerator is an admin tool, and should not be accessible from the web\n\n### Job Filters\nSometimes you may wish to generate only those tiles that satisfy a certain condition.\n\nIf any of these parameters are set, Tilerator will check if a specific tile exists before attempting to regenerate it.\n* `sourceId` - which source to use for filtering. Will use `storageId` by default.\n* `checkZoom` - only generate tiles if the corresponding tile exists at zoom level `checkZoom`.  By default, if any other filter values are set, it uses job's zoom level. If negative, means use job's zoom level minus the value.\n* `dateBefore` - only generate tile if the tile in storage was generated before given date\n* `dateFrom` - only generate tile if the tile in storage was generated after the given date\n* `biggerThan` - only generate tile if the tile in storage is bigger than a given size (compressed)\n* `smallerThan` - only generate tile if the tile in storage is smaller than a given size (compressed)\n* `missing` - if this is set to true, and other filters are not set, gets all the missing tiles.\nIf other filters are set, generates the missing tiles plus the ones that match the filter.\nFor example, to regenerate missing and small tiles, set the `smallerThan` and `missing` parameters.\n\nCurrently `/add/` supports up to two filters. Specify the second filter by adding `2` at the end of each filter parameter.\nIf two filters are given, only tiles that satisfy both filters will be generated.\n\n## Queue cleanup and rebalancing\nAt times, if a job crashes, or the Tilerator is killed by the admin, it will remain in the \"active\" queue without being worked on,\nand its `updated` timestamp will stay the same.  These jobs have to be moved back to the `inactive` queue.\nIn the future it might be possible to fix this automaticaly, but for now, there is a \"clean\" POST request:\n```\nhttp://localhost:6534/cleanup\n```\nWhich by default moves all jobs from `active` to `inactive` if they haven't been updated for the past 60 minutes.\nTo process just one job, specify job ID after cleanup:\n```\nhttp://localhost:6534/cleanup/123\n```\nAlternativelly, the originating queue and the number of minutes can be specified as the first two value after the cleanup.\nThis will move all jobs from the `failed` queue into `inactive` if they haven't been updated in the last 15 minutes:\n```\nhttp://localhost:6534/cleanup/failed/15\n```\n\ncleanup accept these parameters:\n* updateSources - if true, will update the sources of all the matching jobs\n\n\n## Copying source info\nThis command performs copying of the source `info` object from source to destination (immediate, not queued)\n```\nhttp://localhost:6534/setinfo/source/destination\n```\n\nOptionally you can specify the `?tiles=` parameter to update it:\n```\nhttp://localhost:6534/setinfo/gen/c?tiles=http://.../osm/{z}/{x}/{y}.pbf\n```\n\n## Viewing and dynamically changes sources\nYou may view currently configured sources by browsing to the `/sources` URL (GET)\n```\nhttp://localhost:6534/sources\n```\n\nSometimes a temporary source is needed for the generation. Tilerator allows dynamic non-permanent sources to be added\nvia the `/sources` command as well, by POSTing the new YAML configuration to the same URL, in the same format as in the sources file.\nNote that the operation will add sources to the existing ones, overriding the ones with the same name. Variables cannot be changed.\n\n## Viewing defined variables\n```\nhttp://localhost:6534/variables\n```\nThis URL will show the list of defined variables\n\n## Using the `tileshell` shell script\nRunning `script/tileshell.js` is similar to making a single POST request to the tilerator admin interface.\nA new job can be added by supplying `-j.jobparam value` parameters:\n```\nnode scripts/tileshell.js --config config.yaml -j.fromZoom 0 -j.beforeZoom 5 -j.generatorId gen -j.storageId v5 -j.deleteEmpty\n```\n\nThe tool may also be used to export a list of tiles that would be generated. This way one may export existing tiles, or tiles that match a certain filtering criteria:\n```\nnode scripts/tileshell.js --config config.yaml -j.generatorId v5 -j.zoom 3 --dumptiles listOfZoom3TilesInV5.txt\n```\n",
  "readmeFilename": "README.md",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/kartotherian/tilerator.git"
  },
  "scripts": {
    "coverage": "istanbul cover _mocha -- -R spec",
    "docker-start": "service-runner docker-start",
    "docker-test": "service-runner docker-test",
    "start": "service-runner",
    "test": "grunt test"
  },
  "version": "0.0.25"
}
